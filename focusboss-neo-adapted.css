@layer tokens, reset, base, layout, components, utilities, theme, responsive;

/* ========== TOKENS (non-theme + aliases) ========== */
@layer tokens {
    @font-face{font-family:"Poppins";src:url("fonts/poppins-400.woff2") format("woff2");font-weight:400;font-style:normal;font-display:swap;}
    @font-face{font-family:"Poppins";src:url("fonts/poppins-600.woff2") format("woff2");font-weight:600;font-style:normal;font-display:swap;}

    :root{
        /* Keep both schemes available; the active theme sets it explicitly */
        color-scheme:light dark;

        /* Layout + geometry */
        --fb-r-card:16px;
        --fb-r-control:12px;
        --fb-r-pill:999px;

        --fb-s1:6px;
        --fb-s2:10px;
        --fb-s3:16px;
        --fb-s4:20px;

        /* Typography */
        --fb-font-ui:"Poppins",Arial,sans-serif;
        --fb-fz-title:18px;
        --fb-fz-body:13px;
        --fb-fz-small:11px;

        /* ===== Backwards-compatible variable API ===== */
        --r-card:var(--fb-r-card);
        --r-control:var(--fb-r-control);
        --r-chip:var(--fb-r-pill);

        --space-1:var(--fb-s1);
        --space-2:var(--fb-s2);
        --space-3:var(--fb-s3);
        --space-4:var(--fb-s4);

        --font-ui:var(--fb-font-ui);
        --font-title:var(--fb-fz-title);
        --font-body:var(--fb-fz-body);
        --font-small:var(--fb-fz-small);

        /* Semantic color aliases (theme files define --fb-*) */
        --color-bg:var(--fb-bg);
        --color-surface:var(--fb-surface);
        --color-surface-alt:var(--fb-surface-2);
        --color-text:var(--fb-text);
        --color-muted:var(--fb-muted);
        --color-accent:var(--fb-accent);
        --color-border:var(--fb-border);

        /* Neumorphic set (theme files define these explicitly) */
        --neo-bg:var(--fb-surface);
        --neo-bg-alt:var(--fb-surface-2);
        --neo-shadow:var(--fb-shadow-lg);
        --neo-shadow-inset:var(--fb-shadow-inset);
        --neo-shadow-sm:var(--fb-shadow-sm);
        --neo-border:rgba(255,255,255,.04);

        /* Defaults (themes may override) */
        --shadow-card:0 4px 16px rgba(0,0,0,.20);

        --strict-overlay-bg:var(--color-bg);
        --strict-overlay-text:var(--color-text);
        --strict-overlay-muted:var(--color-muted);
        --strict-ring-track:rgba(255,255,255,.12);
        --strict-ring-progress:var(--color-accent);

        --pomodoro-bg:var(--neo-bg);
        --pomodoro-foreground:var(--color-text);
        --pomodoro-muted:var(--neo-bg-alt);
        --pomodoro-muted-foreground:var(--color-muted);
        --pomodoro-accent:var(--color-accent);
        --pomodoro-shadow:var(--neo-shadow);
        --pomodoro-shadow-inset:var(--neo-shadow-inset);
        --pomodoro-shadow-sm:var(--neo-shadow-sm);
    }
}

/* ========== RESET ========== */
@layer reset {
    *,*::before,*::after{box-sizing:border-box;}
    html,body{height:100%;}
    body{margin:0;}
    :where(h1,h2,h3,p){margin:0;}
}

/* ========== BASE ========== */
@layer base {
    body{
        background:var(--color-bg);
        color:var(--color-text);
        font-family:var(--font-ui);
        font-size:var(--font-body);
        min-width:400px;
        min-height:550px;
        overflow:hidden;
    }
    :where(h1,h2,h3){font-weight:600;}
    :where(p){color:var(--color-muted);}
    :where(button,input,select,textarea){font:inherit;color:inherit;}
    :where(button){-webkit-tap-highlight-color:transparent;}
}

/* ========== LAYOUT ========== */
@layer layout {
    .app{display:flex;flex-direction:column;height:100%;min-height:0;width:100%;overflow:hidden;position:relative;}
    .app-header{padding:var(--space-3);display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--neo-border);}
    .app-title{font-size:var(--font-title);}
    .app-main{
        flex:1;
        padding:var(--space-3);
        display:grid;
        gap:var(--space-3);
        overflow-y:auto;
        align-content:start;
        justify-items:center;
        width:100%;
        min-height:0;
        scrollbar-gutter:stable both-edges;
    }
    .app.popup .app-main{justify-items:stretch;}
    .app.popup .card{max-width:100%;}

    .app-main::-webkit-scrollbar{width:6px;}
    .app-main::-webkit-scrollbar-track{background:transparent;}
    .app-main::-webkit-scrollbar-thumb{background:rgba(120,120,120,.40);border-radius:999px;}
    .app-main::-webkit-scrollbar-thumb:hover{background:rgba(120,120,120,.60);}

    .row{display:flex;align-items:center;justify-content:space-between;gap:var(--space-2);}
    .row+.row{margin-top:var(--space-2);}
}

/* ========== COMPONENTS ========== */
@layer components {
    :where(.card,.btn,.chip,.list-item,.time-pill,.day-pill,.icon-btn,.text-input,.segmented,.toggle span){
        background:var(--neo-bg);
        color:var(--color-text);
    }

    .card{border:1px solid var(--neo-border);border-radius:var(--r-card);box-shadow:var(--neo-shadow);padding:var(--space-3);max-width:720px;width:100%;}

    .status-row{display:inline-flex;align-items:center;gap:8px;}
    .status{--_st-border:var(--color-border);--_st-bg:var(--color-surface-alt);border:1px solid var(--_st-border);background:var(--_st-bg);color:var(--color-text);}
    .status-pill{display:inline-flex;align-items:center;padding:4px 10px;border-radius:999px;font-size:12px;}
    .status[data-status="on"]{--_st-border:rgba(156,255,58,.7);--_st-bg:rgba(156,255,58,.14);}
    .status[data-status="off"]{--_st-border:rgba(255,255,255,.08);--_st-bg:rgba(255,255,255,.04);}
    .status[data-status="paused"]{--_st-border:rgba(255,193,7,.6);--_st-bg:rgba(255,193,7,.12);}
    .status[data-status="strict"]{--_st-border:rgba(255,90,90,.6);--_st-bg:rgba(255,90,90,.12);}
    .status[data-status="pomodoro"]{--_st-border:rgba(75,198,255,.7);--_st-bg:rgba(75,198,255,.14);}
    .status[data-status="error"]{--_st-border:rgba(255,120,50,.7);--_st-bg:rgba(255,120,50,.14);}

    .app-nav{border-top:1px solid var(--neo-border);background:var(--neo-bg);padding:8px 16px 10px;display:grid;grid-template-columns:repeat(5,1fr);align-items:center;justify-items:center;width:100%;}
    .nav-btn{
        --_nav-active:0;
        width:100%;height:40px;border:0;background:transparent;color:var(--color-muted);
        cursor:pointer;display:grid;place-items:center;position:relative;transition:color 200ms ease;
    }
    .nav-btn.active{--_nav-active:1;}
    .nav-btn::before{content:"";position:absolute;width:34px;height:34px;border-radius:12px;opacity:var(--_nav-active);transition:opacity 200ms ease;z-index:0;}
    .nav-btn.active::after{content:"";position:absolute;bottom:-10px;width:56px;height:3px;border-radius:999px;background:var(--color-accent);}
    .nav-icon{width:24px;height:24px;display:block;opacity:.75;z-index:1;}
    .nav-icon *{fill:none;stroke:currentColor;stroke-width:1.5;stroke-linecap:round;stroke-linejoin:round;}
    .nav-btn.active .nav-icon{opacity:1;}

    .btn{
        --_btn-bg:var(--neo-bg);
        --_btn-shadow:var(--neo-shadow-sm);
        --_btn-shadow-hover:var(--neo-shadow);
        --_btn-ty:0px;
        --_btn-ty-hover:0px;

        border:0;background:var(--_btn-bg);color:var(--color-text);
        border-radius:var(--r-control);padding:8px 12px;cursor:pointer;
        font-size:var(--font-small);min-width:64px;
        box-shadow:var(--_btn-shadow);
        transform:translateY(var(--_btn-ty));
        transition:box-shadow 200ms ease,transform 200ms ease,background 200ms ease,color 200ms ease;
    }
    .btn:hover{box-shadow:var(--_btn-shadow-hover);transform:translateY(var(--_btn-ty-hover));}
    .btn:active{transform:translateY(1px);}
    .btn.btn-small{padding:8px 14px;min-width:96px;font-size:12px;}
    .btn.btn-large{padding:10px 16px;font-size:12px;width:100%;}
    .btn.btn-primary{--_btn-bg:rgba(156,255,58,.20);}
    .btn.btn-danger{--_btn-bg:rgba(255,90,90,.12);--_btn-shadow-hover:0 10px 24px rgba(255,90,90,.25);--_btn-ty-hover:-1px;}
    .btn.btn-success{--_btn-bg:rgba(156,255,58,.18);--_btn-shadow-hover:0 10px 24px rgba(156,255,58,.25);--_btn-ty-hover:-1px;}

    .icon-btn{
        --_icon-size:20px;--_icon-fz:12px;
        display:inline-flex;align-items:center;justify-content:center;
        width:var(--_icon-size);height:var(--_icon-size);
        border-radius:999px;border:0;background:var(--neo-bg);
        box-shadow:var(--neo-shadow-sm);color:var(--color-muted);
        font-size:var(--_icon-fz);cursor:pointer;
        transition:box-shadow 200ms ease,color 200ms ease,transform 200ms ease;
    }
    .icon-btn:hover{color:var(--color-text);box-shadow:var(--neo-shadow);}
    .icon-btn:active{transform:translateY(1px);}
    .icon-btn.icon-only{--_icon-size:28px;--_icon-fz:14px;}

    .text-input{width:100%;border-radius:var(--r-control);border:0;padding:var(--space-2);box-shadow:var(--neo-shadow-inset);outline:none;}

    .toggle{position:relative;width:44px;height:24px;}
    .toggle input{opacity:0;width:0;height:0;}
    .toggle span{position:absolute;inset:0;border-radius:var(--r-chip);transition:200ms ease;box-shadow:var(--neo-shadow-inset);}
    .toggle span::after{content:"";position:absolute;top:2px;left:2px;width:18px;height:18px;border-radius:50%;background:var(--color-text);transition:200ms ease;}
    .toggle input:checked+span{background:rgba(156,255,58,.30);border-color:rgba(156,255,58,.60);}
    .toggle input:checked+span::after{transform:translateX(20px);background:var(--color-accent);}
    .toggle.small{width:36px;height:20px;}
    .toggle.small span::after{width:14px;height:14px;}
    .toggle.small input:checked+span::after{transform:translateX(16px);}

    .segmented{display:grid;grid-template-columns:repeat(3,1fr);border-radius:var(--r-control);overflow:hidden;box-shadow:var(--neo-shadow-inset);}
    #entryTypeRow.segmented{grid-template-columns:repeat(2,1fr);}
    .segmented.two{grid-template-columns:repeat(2,1fr);}
    .segmented.four{grid-template-columns:repeat(4,1fr);}
    .segmented button{border:0;background:transparent;color:var(--color-muted);padding:var(--space-2);cursor:pointer;transition:200ms ease;}
    .segmented button.active{background:var(--neo-bg);color:var(--color-text);box-shadow:var(--neo-shadow-sm);}

    .stats-tabs-row{flex-wrap:wrap;}
    .stats-tabs-row>*{min-width:0;}
    .stats-tabs-row .segmented{width:100%;}
    .segmented.four button{padding:6px 8px;font-size:11px;}

    .stats-panel{opacity:0;transform:translateY(6px);max-height:0;overflow:hidden;transition:opacity 200ms ease,transform 200ms ease,max-height 200ms ease;}
    .stats-panel.active{opacity:1;transform:translateY(0);max-height:480px;}

    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 14px;border-radius:var(--r-chip);border:0;font-size:12px;cursor:pointer;box-shadow:var(--neo-shadow-sm);transition:200ms ease;}
    #strictDurations{display:grid;grid-template-columns:repeat(auto-fit,minmax(54px,1fr));gap:8px;}
    #strictDurations .chip{justify-content:center;text-align:center;}
    .chip.active{background:var(--color-accent);color:var(--color-text);box-shadow:var(--neo-shadow-inset);}
    .chip[disabled]{opacity:.5;cursor:not-allowed;}

    .list-items{display:grid;gap:8px;}
    .list-item{display:flex;align-items:center;justify-content:space-between;gap:var(--space-2);padding:8px 10px;border-radius:var(--r-control);font-size:var(--font-small);overflow:visible;box-shadow:var(--neo-shadow-sm);}
    .list-item button{border:0;background:transparent;color:var(--color-muted);cursor:pointer;transition:color 200ms ease;}
    .list-item button:hover{color:var(--color-accent);}
    .list-title{font-weight:600;}
    .list-sub{font-size:var(--font-small);color:var(--color-muted);}

    .modal{position:fixed;inset:0;z-index:9999;display:grid;place-items:center;}
    .modal.hidden{display:none;}
    body.modal-open{overflow:hidden;}
    .modal-backdrop{position:absolute;inset:0;background:#ececec;backdrop-filter:blur(26px) saturate(180%);}
    .modal-card{position:relative;width:min(92vw,420px);border-radius:24px;padding:18px;background:var(--neo-bg);border:1px solid var(--neo-border);box-shadow:var(--neo-shadow);z-index:1;}
    .modal-actions{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;}
    .strict-desc{font-size:14px;color:var(--color-muted);}

    .strict-overlay{position:absolute;inset:0;z-index:5000;background:var(--strict-overlay-bg);display:grid;place-items:center;padding:24px;color:var(--strict-overlay-text);}
    .strict-overlay.hidden{display:none;}
    .strict-overlay-content{text-align:left;display:grid;gap:8px;max-width:320px;width:100%;}
    .strict-overlay .list-sub{color:var(--strict-overlay-muted);}
    .strict-overlay-close{position:absolute;top:12px;right:12px;}

    .task-form{display:grid;gap:10px;}
    .task-range{display:flex;align-items:center;gap:8px;}
    .task-range input[type="range"]{flex:1;accent-color:var(--color-accent);}
    .task-empty{color:var(--color-muted);}
    .task-item{gap:10px;}
    .task-main{display:grid;gap:4px;min-width:0;}
    .task-title{font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .task-meta{font-size:11px;color:var(--color-muted);}
    .task-actions{display:inline-flex;align-items:center;gap:8px;}
    .task-done .task-title{text-decoration:line-through;color:var(--color-muted);}

    .pomodoro-header{display:grid;grid-template-columns:minmax(0,1fr) auto;align-items:center;gap:12px;}
    .pomodoro-title{min-width:0;}
    .pomodoro-title h3{font-size:1.5em;}
    .pomodoro-controls{display:flex;align-items:center;justify-content:center;gap:16px;}
    .pomodoro-control{border:0;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:200ms ease;color:inherit;}
    .pomodoro-control.secondary{width:48px;height:48px;border-radius:50%;background:var(--pomodoro-bg);box-shadow:var(--pomodoro-shadow-sm);color:var(--pomodoro-muted-foreground);}
    .pomodoro-control.secondary:hover{color:var(--pomodoro-foreground);}
    .pomodoro-control.secondary:active{box-shadow:var(--pomodoro-shadow-inset);}
    .pomodoro-control.primary{width:64px;height:64px;border-radius:50%;background:var(--pomodoro-accent);color:var(--pomodoro-foreground);box-shadow:0 4px 16px var(--pomodoro-shadow);}
    .pomodoro-control.primary:hover{transform:scale(1.05);}
    .pomodoro-control.primary:active{transform:scale(0.95);}
    .pomodoro-control svg{width:20px;height:20px;fill:currentColor;}
    .pomodoro-control.primary svg{width:24px;height:24px;}
    .pomodoro-control[disabled]{opacity:.45;cursor:not-allowed;}
    .pomodoro-fields{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;}

    .neo-timer{position:relative;width:240px;height:240px;margin:0 auto;}
    .neo-timer-outer{position:absolute;inset:0;border-radius:50%;background:var(--neo-timer-bg,var(--neo-bg));box-shadow:var(--neo-timer-shadow,var(--neo-shadow));}
    .neo-timer-inner{position:absolute;inset:20px;border-radius:50%;background:var(--neo-timer-bg,var(--neo-bg));box-shadow:var(--neo-timer-shadow-inset,var(--neo-shadow-inset));}
    .neo-timer-svg{position:absolute;inset:0;transform:rotate(-90deg);}
    .neo-timer-track{fill:none;stroke:var(--neo-timer-muted,var(--neo-bg-alt));stroke-width:12;stroke-linecap:round;}
    .neo-timer-progress{fill:none;stroke:var(--neo-timer-accent,var(--color-accent));stroke-width:12;stroke-linecap:round;transition:stroke-dashoffset 300ms ease-out;filter:drop-shadow(0 0 6px rgba(0,0,0,.15));}
    .neo-timer-time{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;}
    .neo-timer-value{font-size:40px;font-weight:600;letter-spacing:-1px;color:var(--neo-timer-foreground,var(--color-text));}
    .neo-timer-label{margin-top:8px;font-size:12px;color:var(--neo-timer-muted-foreground,var(--color-muted));}

    .pomodoro-timer{--neo-timer-bg:var(--pomodoro-bg);--neo-timer-foreground:var(--pomodoro-foreground);--neo-timer-muted:var(--pomodoro-muted);--neo-timer-muted-foreground:var(--pomodoro-muted-foreground);--neo-timer-accent:var(--pomodoro-accent);--neo-timer-shadow:var(--pomodoro-shadow);--neo-timer-shadow-inset:var(--pomodoro-shadow-inset);}
    .strict-timer{--neo-timer-bg:var(--strict-overlay-bg);--neo-timer-foreground:var(--strict-overlay-text);--neo-timer-muted:var(--strict-ring-track);--neo-timer-muted-foreground:var(--strict-overlay-muted);--neo-timer-accent:var(--strict-ring-progress);--neo-timer-shadow:var(--neo-shadow);--neo-timer-shadow-inset:var(--neo-shadow-inset);}

    .intervention-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;}
    .intervention-card{display:grid;gap:10px;padding:12px;border-radius:var(--r-control);border:1px solid var(--color-border);background:var(--color-surface-alt);cursor:pointer;transition:border-color 200ms ease,transform 200ms ease;}
    .intervention-card:hover{border-color:rgba(156,255,58,.5);}
    .intervention-card:active{transform:translateY(1px);}
    .intervention-title{font-weight:600;font-size:13px;}
    .intervention-radio{justify-self:end;}
    .intervention-radio input{accent-color:var(--color-accent);cursor:pointer;}
    .intervention-details{display:grid;gap:10px;}
    .intervention-section{display:grid;gap:6px;}
    .intervention-section-title{font-size:11px;color:var(--color-muted);text-transform:uppercase;letter-spacing:.04em;}
    @media (max-width:360px){.intervention-grid{grid-template-columns:1fr;}}

    .intervention-stage,.hold-stage{display:grid;gap:10px;}
    .hold-progress{height:6px;background:rgba(255,255,255,.08);border-radius:999px;overflow:hidden;}
    .hold-progress span{display:block;height:100%;width:0%;background:var(--color-accent);}
    .gate-stage{position:relative;border-radius:var(--r-control);border:1px solid var(--color-border);background:var(--color-surface-alt);height:80px;overflow:hidden;display:grid;place-items:center;}
    .gate-panel{position:absolute;inset:0;background:linear-gradient(90deg,rgba(156,255,58,.2),rgba(255,255,255,.04));animation:gate-slide var(--gate-duration,8s) ease-in-out forwards;}
    @keyframes gate-slide{to{transform:translateX(100%);}}
    .breath-stage{display:grid;gap:10px;place-items:center;text-align:center;}
    .breath-circle{width:100px;height:100px;border-radius:50%;background:radial-gradient(circle,rgba(156,255,58,.4),rgba(156,255,58,.1));transform:scale(.6);transition:transform 4s ease-in-out;}

    .schedule-days{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:4px;margin-top:6px;}
    .schedule-item{cursor:pointer;}
    .schedule-meta{display:grid;gap:6px;min-width:0;}
    .schedule-title{display:inline-flex;align-items:center;gap:8px;flex-wrap:wrap;min-width:0;}
    .schedule-actions{display:grid;align-items:center;justify-items:end;gap:10px;}
    .schedule-name{flex:1 1 auto;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .time-pill{flex:0 0 auto;padding:2px 8px;border-radius:999px;border:0;color:var(--color-muted);font-size:10px;white-space:nowrap;box-shadow:var(--neo-shadow-sm);}
    .day-pill{display:inline-flex;align-items:center;justify-content:center;padding:2px 6px;border-radius:999px;font-size:10px;border:0;color:var(--color-muted);box-shadow:var(--neo-shadow-sm);}
    .schedule-actions .icon-btn[data-delete-schedule]{border-radius:12px;border:1px solid rgba(120,120,120,.4);background:rgba(120,120,120,.08);color:rgba(200,200,200,.7);transition:border-color 200ms ease,box-shadow 200ms ease,color 200ms ease;}
    .schedule-actions .icon-btn[data-delete-schedule]:hover{border-color:rgba(255,90,90,.85);color:rgba(255,90,90,.9);box-shadow:0 10px 24px rgba(255,90,90,.25);}

    .stats-row{display:grid;gap:6px;}
    .stats-bar{height:6px;border-radius:999px;background:rgba(156,255,58,.25);border:1px solid rgba(156,255,58,.4);}
    .stats-bar span{display:block;height:100%;border-radius:inherit;background:rgba(156,255,58,.8);}
    .stats-bar.fixed{width:100%;max-width:160px;}
    @media (max-width:430px){.stats-bar.fixed{max-width:140px;}}

    .stats-grid{display:grid;column-gap:12px;row-gap:10px;grid-template-columns:repeat(2,minmax(0,1fr));overflow:visible;}
    .stats-column{display:grid;gap:8px;min-width:0;overflow:visible;}
    .stats-item{display:grid;gap:6px;width:100%;}
    .stats-label{display:grid;grid-template-columns:auto 1fr;align-items:center;gap:8px;overflow:visible;}
    .stats-pill{padding:2px 8px;border-radius:999px;background:rgba(156,255,58,.16);border:1px solid rgba(156,255,58,.35);color:var(--color-text);font-size:11px;white-space:nowrap;}
    .stats-domain{font-size:var(--font-small);color:var(--color-text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;position:relative;display:inline-block;max-width:100%;}

    .metric-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;}
    .metric-card{padding:12px;border-radius:var(--r-control);border:1px solid var(--color-border);background:var(--color-surface-alt);}
    .metric-value{font-size:18px;font-weight:600;margin-top:4px;}
    .chip-row{display:flex;gap:6px;flex-wrap:wrap;}

    .session-item{display:grid;gap:6px;}
    .session-title{font-weight:600;font-size:13px;}
    .session-meta{display:flex;gap:8px;flex-wrap:wrap;color:var(--color-muted);font-size:12px;}

    .settings-link{display:block;padding:10px 12px;border-radius:var(--r-control);border:1px solid var(--color-border);background:var(--color-surface-alt);color:var(--color-text);text-decoration:none;font-size:13px;}
    .settings-link[aria-disabled="true"]{opacity:.6;cursor:default;}

    .settings-footer{margin-top:16px;display:grid;justify-items:center;gap:6px;text-align:center;}
    .footer-link{color:var(--color-text);text-decoration:none;font-size:12px;}
    .footer-link:hover{text-decoration:underline;}

    .timeline-row{display:grid;gap:6px;margin-bottom:10px;}
    .timeline-bar{height:8px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden;}
    .timeline-bar span{display:block;height:100%;background:var(--color-accent);}

    .stacked-list{display:grid;gap:8px;}
    .stacked-row{display:grid;gap:6px;font-size:var(--font-small);}
    .stacked-bars{display:flex;height:10px;border-radius:999px;overflow:hidden;border:1px solid rgba(156,255,58,.25);background:rgba(255,255,255,.05);}
    .stacked-bars .focus{background:rgba(156,255,58,.8);}
    .stacked-bars .blocked{background:rgba(255,90,90,.8);}

    .stacked-vertical{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));gap:8px;align-items:end;height:140px;overflow-x:hidden;}
    .stacked-vertical.month{height:auto;overflow-x:hidden;}
    .stacked-col{display:grid;grid-template-rows:1fr auto;gap:6px;justify-items:center;height:100%;align-content:end;}
    .stacked-pillar{width:100%;max-width:10px;display:flex;flex-direction:column;justify-content:flex-end;border-radius:999px;overflow:hidden;border:1px solid rgba(156,255,58,.2);background:rgba(255,255,255,.05);}
    .stacked-pillar .focus{background:rgba(156,255,58,.8);}
    .stacked-pillar .blocked{background:rgba(255,90,90,.8);}

    .month-scroll{overflow-x:auto;overflow-y:hidden;padding-bottom:10px;}
    .month-scroll::-webkit-scrollbar{height:6px;}
    .month-scroll::-webkit-scrollbar-thumb{background:rgba(120,120,120,.40);border-radius:999px;}
    .month-bars{display:flex;align-items:flex-end;gap:8px;height:160px;}
    .month-bar{display:grid;grid-template-rows:1fr auto;gap:6px;justify-items:center;min-width:18px;}
    .stacked-label{font-size:10px;color:var(--color-muted);}

    .legend{display:inline-flex;align-items:center;gap:6px;font-size:var(--font-small);color:var(--color-muted);}
    .legend .dot{width:8px;height:8px;border-radius:999px;display:inline-block;}
    .legend .dot.focus{background:rgba(156,255,58,.8);}
    .legend .dot.blocked{background:rgba(255,90,90,.8);}

    .donut-wrap{display:grid;grid-template-columns:auto 1fr;gap:16px;align-items:center;}
    .donut{width:140px;height:140px;display:grid;place-items:center;position:relative;}
    .donut-svg{position:absolute;inset:0;}
    .donut-svg svg{width:100%;height:100%;transform:rotate(-90deg);}
    .donut-center{position:absolute;inset:0;display:grid;place-items:center;text-align:center;pointer-events:none;}
    .donut-total-value{font-size:clamp(12px,3.5vw,18px);font-weight:600;color:var(--color-text);max-width:110px;text-align:center;word-break:break-word;}
    .legend-list{display:grid;gap:8px;font-size:var(--font-small);}
    .legend-item{display:grid;grid-template-columns:auto 1fr auto;gap:8px;align-items:center;}
    .legend-dot{width:10px;height:10px;border-radius:999px;}
    .legend-label{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .legend-value{color:var(--color-muted);}

    .heatmap{display:grid;grid-template-columns:repeat(6,1fr);gap:6px;}
    .heat-cell{border-radius:8px;height:28px;display:grid;place-items:center;font-size:10px;color:var(--color-text);border:1px solid rgba(255,255,255,.08);}
}


/* ========== UTILITIES ========== */
@layer utilities { .hidden{display:none;} }

/* ========== THEME (light mode) ========== */
@layer theme {
    html[data-theme="light"]{
        color-scheme:light;

        --fb-bg:#f3f4f4;
        --fb-surface:#ffffff;
        --fb-surface-2:#eef0f0;
        --fb-text:#1b1f1f;
        --fb-muted:#5b6364;
        --fb-accent:hsl(48,100%,55%);
        --fb-border:rgba(0,0,0,.01);

        --fb-shadow-lg:8px 8px 16px rgba(0,0,0,.12),-8px -8px 16px rgba(255,255,255,.9);
        --fb-shadow-inset:inset 4px 4px 8px rgba(0,0,0,.08),inset -4px -4px 8px rgba(255,255,255,.9);
        --fb-shadow-sm:4px 4px 8px rgba(0,0,0,.10),-4px -4px 8px rgba(255,255,255,.9);

        --shadow-card:0 4px 16px rgba(0,0,0,.08);

        /* Neumorphic surfaces (light uses a “paper” surface distinct from white panels) */
        --neo-bg:#ececec;
        --neo-bg-alt:#e9edf3;
        --neo-shadow:var(--fb-shadow-lg);
        --neo-shadow-inset:var(--fb-shadow-inset);
        --neo-shadow-sm:var(--fb-shadow-sm);
        --neo-border:rgba(0,0,0,.04);

        /* Strict overlay */
        --strict-overlay-bg:#ffffff;
        --strict-overlay-text:#101010;
        --strict-overlay-muted:#5b6364;
        --strict-ring-track:rgba(0,0,0,.12);
        --strict-ring-progress:var(--fb-accent);

        /* Pomodoro */
        --pomodoro-bg:var(--neo-bg);
        --pomodoro-foreground:var(--fb-text);
        --pomodoro-muted:var(--neo-bg-alt);
        --pomodoro-muted-foreground:var(--fb-muted);
        --pomodoro-accent:var(--fb-accent);
        --pomodoro-shadow:var(--neo-shadow);
        --pomodoro-shadow-inset:var(--neo-shadow-inset);
        --pomodoro-shadow-sm:var(--neo-shadow-sm);
    }

    /* Light-only micro-tweaks (kept isolated here) */
    html[data-theme="light"] .toggle input:checked+span{background:rgba(242,201,76,.35);}

    html[data-theme="light"] .btn.btn-danger{
        --_btn-bg:#ffe7e7;
        color:#7a1f1f;
        --_btn-shadow-hover:0 10px 24px rgba(214,69,69,.25);
    }
    html[data-theme="light"] .btn.btn-success{
        --_btn-bg:#e8fad9;
        color:#1f5f1f;
        --_btn-shadow-hover:0 10px 24px rgba(46,143,46,.25);
    }

    html[data-theme="light"] .timeline-bar{background:rgba(0,0,0,.08);}

    html[data-theme="light"] .schedule-name{color:#0d0c0b;}
    html[data-theme="light"] .schedule-days{gap:6px;}

    html[data-theme="light"] .schedule-actions .icon-btn[data-delete-schedule]{
        border-color:rgba(80,80,80,.2);
        background:rgba(80,80,80,.05);
        color:rgba(80,80,80,.6);
    }
    html[data-theme="light"] .schedule-actions .icon-btn[data-delete-schedule]:hover{
        border-color:rgba(214,69,69,.85);
        color:rgba(214,69,69,.9);
        box-shadow:0 10px 24px rgba(214,69,69,.2);
    }
}


@layer theme {
    html:not([data-theme]), html[data-theme="dark"]{
        color-scheme:dark;

        --fb-bg:#0e1111;
        --fb-surface:#161a1a;
        --fb-surface-2:#1d2222;
        --fb-text:#f5f5f5;
        --fb-muted:#a4abac;
        --fb-accent:#9cff3a;
        --fb-border:rgba(255,255,255,.08);

        --fb-shadow-lg:8px 8px 16px rgba(0,0,0,.35),-8px -8px 16px rgba(255,255,255,.04);
        --fb-shadow-inset:inset 4px 4px 8px rgba(0,0,0,.35),inset -4px -4px 8px rgba(255,255,255,.05);
        --fb-shadow-sm:4px 4px 8px rgba(0,0,0,.30),-4px -4px 8px rgba(255,255,255,.04);

        --shadow-card:0 4px 16px rgba(0,0,0,.20);

        /* Neumorphic surfaces */
        --neo-bg:var(--fb-surface);
        --neo-bg-alt:var(--fb-surface-2);
        --neo-shadow:var(--fb-shadow-lg);
        --neo-shadow-inset:var(--fb-shadow-inset);
        --neo-shadow-sm:var(--fb-shadow-sm);
        --neo-border:rgba(255,255,255,.04);

        /* Strict overlay */
        --strict-overlay-bg:var(--fb-bg);
        --strict-overlay-text:var(--fb-text);
        --strict-overlay-muted:var(--fb-muted);
        --strict-ring-track:rgba(255,255,255,.12);
        --strict-ring-progress:var(--fb-accent);

        /* Pomodoro */
        --pomodoro-bg:var(--neo-bg);
        --pomodoro-foreground:var(--fb-text);
        --pomodoro-muted:var(--neo-bg-alt);
        --pomodoro-muted-foreground:var(--fb-muted);
        --pomodoro-accent:var(--fb-accent);
        --pomodoro-shadow:var(--neo-shadow);
        --pomodoro-shadow-inset:var(--neo-shadow-inset);
        --pomodoro-shadow-sm:var(--neo-shadow-sm);
    }
}



/* ========== RESPONSIVE ========== */

/* ========== ENHANCEMENTS (non-breaking adapter) ========== */
@layer components {
  /* Focus ring: consistent, unobtrusive */
  :where(.btn,.icon-btn,.chip,.text-input,.segmented button,.toggle span,input[type="radio"],input[type="checkbox"],select,textarea):focus-visible{
    outline: none;
    box-shadow:
      0 0 0 2px color-mix(in oklab, var(--color-accent) 45%, transparent),
      var(--neo-shadow-sm);
  }

  /* Disabled states */
  :where(.btn,.icon-btn,.chip,.segmented button)[disabled],
  :where(.btn,.icon-btn,.chip,.segmented button).disabled{
    opacity:.55;
    cursor:not-allowed;
    transform:none;
  }
  :where(.btn,.icon-btn,.chip,.segmented button)[disabled]:hover{
    box-shadow:var(--neo-shadow-sm);
  }

  /* Nav active "soft tile" behind icon (was transparent) */
  .nav-btn::before{
    background: var(--neo-bg);
    box-shadow: var(--neo-shadow-inset);
    border: 1px solid var(--neo-border);
  }

  /* Toggle: add border + better pressed feel */
  .toggle span{
    border: 1px solid var(--neo-border);
  }
  .toggle input:checked+span{
    box-shadow: var(--neo-shadow-sm);
  }
  .toggle input:active+span{
    box-shadow: var(--neo-shadow-inset);
  }

  /* Native radio: neomorphic without extra markup */
  input[type="radio"]{
    appearance:none;
    -webkit-appearance:none;
    width:18px;height:18px;
    border-radius:999px;
    border: 1px solid var(--neo-border);
    background: var(--neo-bg);
    box-shadow: var(--neo-shadow-inset);
    display:inline-grid;
    place-items:center;
    vertical-align:middle;
    cursor:pointer;
    transition:200ms ease;
  }
  input[type="radio"]:hover{ box-shadow: var(--neo-shadow); }
  input[type="radio"]:checked{
    background:
      radial-gradient(circle, var(--color-accent) 0 42%, transparent 46%) ,
      var(--neo-bg);
    box-shadow: var(--neo-shadow-inset);
  }

  /* Native checkbox (optional): matches radio look */
  input[type="checkbox"]{
    appearance:none;
    -webkit-appearance:none;
    width:18px;height:18px;
    border-radius:6px;
    border: 1px solid var(--neo-border);
    background: var(--neo-bg);
    box-shadow: var(--neo-shadow-inset);
    display:inline-grid;
    place-items:center;
    vertical-align:middle;
    cursor:pointer;
    transition:200ms ease;
  }
  input[type="checkbox"]:hover{ box-shadow: var(--neo-shadow); }
  input[type="checkbox"]:checked{
    background: color-mix(in oklab, var(--color-accent) 25%, var(--neo-bg));
    box-shadow: var(--neo-shadow-inset);
  }
  input[type="checkbox"]:checked::after{
    content:"";
    width:10px;height:6px;
    border-left:2px solid var(--color-accent);
    border-bottom:2px solid var(--color-accent);
    transform:rotate(-45deg) translateY(-1px);
  }

  /* Modal backdrop: theme-aware */
  .modal-backdrop{
    background: color-mix(in oklab, var(--color-bg) 72%, var(--neo-bg));
  }
}

@layer responsive {
  @media (prefers-reduced-motion: reduce){
    *{animation-duration:0.001ms !important;animation-iteration-count:1 !important;transition-duration:0.001ms !important;scroll-behavior:auto !important;}
  }
}

@layer responsive {
    @media (min-width:900px){
        .app-main{padding:28px;gap:20px;}
        .card{padding:22px 24px;}
        .app-title{font-size:20px;}
    }
}
